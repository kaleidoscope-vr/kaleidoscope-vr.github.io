<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Layouts &raquo; Hero-Thirds</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Roboto:500,300,400"
      type="text/css"
    />
    <link href="assets/css/style.css" rel="stylesheet" type="text/css" />
    <link
      href="assets/css/keen-dashboards.css"
      rel="stylesheet"
      type="text/css"
    />
    <!-- Demo Dependencies -->
    <script
      crossorigin
      src="https://cdnjs.cloudflare.com/ajax/libs/holder/2.9.6/holder.js"
      type="text/javascript"
    ></script>
    <script>
      Holder.addTheme("white", {
        bg: "#fff",
        fg: "#a7a7a7",
        size: 10
      });
    </script>

    <!-- keen-analysis@3 -->
    <script
      crossorigin
      src="https://cdn.jsdelivr.net/npm/keen-analysis@3/dist/keen-analysis.min.js"
      type="text/javascript"
    ></script>

    <!-- keen-dataviz@3 -->
    <link
      crossorigin
      href="https://cdn.jsdelivr.net/npm/keen-dataviz@3/dist/keen-dataviz.min.css"
      rel="stylesheet"
    />
    <script
      crossorigin
      src="https://cdn.jsdelivr.net/npm/keen-dataviz@3/dist/keen-dataviz.min.js"
      type="text/javascript"
    ></script>

    <!-- Dashboard -->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
    />
  </head>

  <body class="keen-dashboard">
    <div class="container">
      <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="navbar-header">
          <button
            type="button"
            class="navbar-toggle"
            data-toggle="collapse"
            data-target=".navbar-collapse"
          >
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>

          <a class="navbar-brand" href="./">Kaleidoscope Dashboards</a>
        </div>
      </div>
    </div>

    <div class="container grid grid-hero-thirds">
      <div class="grid-hero">
        <div class="hero chart-wrapper">
          <div class="chart-title">
            User activation funnel
          </div>
          <div class="chart-stage">
            <div style="height: 450px" id="onboarding-funnel"></div>
          </div>
          <div class="chart-notes">
            ...
          </div>
        </div>
        <div class="chart-wrapper">
          <div class="chart-title">
            Total Users
          </div>
          <div class="chart-stage">
            <div id="approved-user"></div>
          </div>
          <div class="chart-notes">
            ...
          </div>
          <div class="chart-title">
            Unclaimmed account
          </div>
          <div class="chart-stage">
            <div id="average-user"></div>
          </div>
          <div class="chart-notes">
            ...
          </div>
        </div>
      </div>
      <div class="grid-hero">
        <div class="hero chart-wrapper">
          <div class="chart-title">
            Project Publishing Funnel
          </div>
          <div class="chart-stage">
            <div style="height: 450px" id="project-publishing-funnel"></div>
          </div>
          <div class="chart-notes">
            ...
          </div>
        </div>
        <div class="chart-wrapper">
          <div class="chart-title">
            Total money raised to now
          </div>
          <div class="chart-stage">
            <div id="money-rise-container"></div>
          </div>
          <div class="chart-notes">
            ...
          </div>
          <div class="chart-title">
            Current Invested
          </div>
          <div class="chart-stage">
            <div id="money-currentinvested-container"></div>
          </div>
          <div class="chart-notes">
            ...
          </div>
        </div>
      </div>
      <div class="chart-wrapper">
        <div class="chart-title">
          Average Raise
        </div>
        <div class="chart-stage">
          <div id="average-raise"></div>
        </div>
        <div class="chart-notes">
          Notes about this chart
        </div>
      </div>
      <div class="chart-wrapper">
        <div class="chart-title">
          Average Budget
        </div>
        <div class="chart-stage">
          <div id="average-budget"></div>
        </div>
        <div class="chart-notes">
          Notes about this chart
        </div>
      </div>
      <!-- <div class="chart-wrapper">
        <div class="chart-title">
          Cell Title
        </div>
        <div class="chart-stage">
          <img data-src="holder.js/100px120?theme=white" />
        </div>
        <div class="chart-notes">
          Notes about this chart
        </div>
      </div>
      <div class="chart-wrapper" id="1">
        <div class="chart-title">
          Cell Title
        </div>
        <div class="chart-stage">
          <img data-src="holder.js/100px120?theme=white" />
        </div>
        <div class="chart-notes">
          Notes about this chart
        </div>
      </div>
      <div class="chart-wrapper">
        <div class="chart-title">
          Cell Title
        </div>
        <div class="chart-stage">
          <img data-src="holder.js/100px120?theme=white" />
        </div>
        <div class="chart-notes">
          Notes about this chart
        </div>
      </div>
      <div class="chart-wrapper">
        <div class="chart-title">
          Cell Title
        </div>
        <div class="chart-stage">
          <img data-src="holder.js/100px120?theme=white" />
        </div>
        <div class="chart-notes">
          Notes about this chart
        </div>
      </div> -->
    </div>

    <div class="container">
      <p class="small text-muted">
        Built with &#9829; by
        <a href="https://Kaleidoscope.fund">Kaleidoscope</a>
      </p>
    </div>

    <script>
      function toggleMenu() {
        const toggleBtn = document.querySelector(".navbar-toggle");

        toggleBtn.addEventListener("click", e => {
          let menu;
          if (e.currentTarget.dataset.target) {
            menu = document.querySelector(e.currentTarget.dataset.target);
          }
          if (menu) menu.classList.toggle("collapsed");
        });
      }

      window.addEventListener("DOMContentLoaded", toggleMenu);
    </script>
    <script>
      //init
      var client = new Keen({
        projectId: "5cac73d9c9e77c0001ee11d5",
        readKey:
          "360481CD441FD2521513B23D1FFAEDF685B04F293695275140DB1D3969A955F5E4B603312A0F1B49BECADCF07BADE16F450CA5C51845AA98ABEE52524AF66951431B47FDD43910C1A97D7086922D17579C5428BF2D9875056A1D16D4225A1A81"
      });

      //total number of users
      var approvedUser = new KeenDataviz({
        container: "#approved-user",
        type: "metric",
        title: "Users"
      });

      client
        .query("count_unique", {
          event_collection: "approved",
          target_property: "user.id",
          timeframe: "this_14_months"
        })
        .then(function(res) {
          console.log("res", res);
          approvedUser.data(res).render();
        })
        .catch(function(err) {
          approvedUser.message(err.message);
        });

      ///

      //total number of users
      var uniqueVisitors = new KeenDataviz({
        container: "#average-user",
        type: "metric",
        title: "Users"
      });

      client
        .query("count_unique", {
          event_collection: "accepted",
          target_property: "user.id",
          timeframe: "this_14_months"
        })
        .then(function(res) {
          console.log("res", res);
          uniqueVisitors.data(res).render();
        })
        .catch(function(err) {
          uniqueVisitors.message(err.message);
        });

      ///

      const chart = new KeenDataviz({
        container: "#onboarding-funnel",
        height: 400,
        showLoadingSpinner: true,
        type: "funnel",
        labelMapping: {
          reviewing: "Reviewing",
          accepted: "Accepted (upvoted)",
          approved: "Approved (Confirm data)",
          session: "Activated"
        },
        funnel: {
          percents: {
            show: true
          }
        }
      });

      client
        .query({
          analysis_type: "funnel",
          steps: [
            {
              actor_property: "user.id",
              event_collection: "reviewing",
              timeframe: "this_14_months"
            },
            {
              actor_property: "user.id",
              event_collection: "accepted",
              timeframe: "this_14_months"
            },
            {
              actor_property: "user.id",
              event_collection: "approved",
              timeframe: "this_14_months"
            },
            {
              actor_property: "user.id",
              event_collection: "session",
              timeframe: "this_14_months",
              with_actors: true
            }
          ]
        })
        .then(function(funnelRes) {
          let _funnelRes = funnelRes;
          console.log(_funnelRes.actors[3]);
          let result = [];
          for (let i = 0; i < _funnelRes.actors[3].length; i++) {
            console.log("goes here");
            result[i] = client.query("count", {
              eventCollection: "session",
              targetProperty: "user.id",
              timeframe: "this_14_months",
              filters: [
                {
                  property_name: "user.id",
                  operator: "eq",
                  property_value: _funnelRes.actors[3][i]
                }
              ]
            });
          }

          Promise.all(result).then(function(values) {
            console.log("values", values);

            //check if user has more than one session
            for (let i = 0; i < values.length; i++) {
              if (values.result > 3) {
                _funnelRes.actors[3].push(
                  values[i].query.filters[0].property_value
                );
              }
            }

            chart.render(_funnelRes);
          });
        })
        .catch(function(err) {
          // Handle the error
          chart.message(err.message);
        });

      //Project publishing dashboard
      const projectPublishingFunnel = new KeenDataviz({
        container: "#project-publishing-funnel",
        height: 400,
        type: "funnel",
        showLoadingSpinner: true,
        labelMapping: {
          draft: "Draft",
          inDevelopment: "In Development",
          completed: "Completed"
        },
        funnel: {
          percents: {
            show: true
          }
        }
      });

      client
        .query({
          analysis_type: "funnel",
          steps: [
            {
              actor_property: "project.id",
              event_collection: "draft",
              timeframe: "this_14_months"
            },
            {
              actor_property: "project.id",
              event_collection: "inDevelopment",
              timeframe: "this_14_months",
              optional: true
            },
            {
              actor_property: "project.id",
              event_collection: "completed",
              timeframe: "this_14_months",
              optional: true
            }
          ]
        })
        .then(function(funnelRes) {
          projectPublishingFunnel.render(funnelRes);
        })
        .catch(function(err) {
          // Handle the error
          projectPublishingFunnel.message(err.message);
        });

      //total number of users
      var moneyRise = new KeenDataviz({
        container: "#money-rise-container",
        type: "metric",
        title: "Rise to now"
      });

      client
        .query("sum", {
          event_collection: "project",
          target_property: "project.totalInvested",
          timeframe: "this_14_months"
        })
        .then(function(res) {
          console.log("res from Sum", res);
          moneyRise.data(res).render();
        })
        .catch(function(err) {
          moneyRise.message(err.message);
        });

      //current number of users
      var moneyCurrentInvested = new KeenDataviz({
        container: "#money-currentinvested-container",
        type: "metric",
        title: "Invested money"
      });

      client
        .query("sum", {
          event_collection: "project",
          target_property: "project.currentinvested",
          timeframe: "this_14_months",
          prefix: "$"
        })
        .then(function(res) {
          console.log("res from Sum", res);
          moneyCurrentInvested.data(res).render();
        })
        .catch(function(err) {
          moneyCurrentInvested.message(err.message);
        });

      //average-raise
      var averageRaise = new KeenDataviz({
        container: "#average-raise",
        type: "metric",
        title: "Average Raise"
      });

      client
        .query("average", {
          event_collection: "inDevelopment",
          target_property: "project.currentInvested",
          timeframe: "this_14_months"
        })
        .then(function(res) {
          console.log("res from Sum", res);
          averageRaise.data(res).render();
        })
        .catch(function(err) {
          averageRaise.message(err.message);
        });

      //average-budget
      var averageBuget = new KeenDataviz({
        container: "#average-budget",
        type: "metric",
        title: "Average Budget"
      });

      client
        .query("average", {
          event_collection: "inDevelopment",
          target_property: "project.totalInvested",
          timeframe: "this_14_months"
        })
        .then(function(res) {
          console.log("res from Sum", res);
          averageBuget.data(res).render();
        })
        .catch(function(err) {
          averageBuget.message(err.message);
        });

      //main nav
      function toggleMenu() {
        const toggleBtn = document.querySelector(".navbar-toggle");

        toggleBtn.addEventListener("click", e => {
          let menu;
          if (e.currentTarget.dataset.target) {
            menu = document.querySelector(e.currentTarget.dataset.target);
          }
          if (menu) menu.classList.toggle("collapsed");
        });
      }

      window.addEventListener("DOMContentLoaded", toggleMenu);
    </script>
  </body>
</html>
